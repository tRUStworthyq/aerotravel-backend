# 003. Управление распределенными транзакциями: Saga Pattern

* **Статус:** Принято
* **Владелец решения:** Максим Долгий dolgiy_m@list.ru
* **Дата:** 25.10.2025

## Контекст и постановка проблемы

В связи с выбором микросервисной архитектуры [ADR-001](001-microservices-architecture.md) и использованием Kafka для
асинхронного взаимодействия между сервисами [ADR-002](002-asynchronous-messaging.md), возникла необходимость обеспечения
согласованности данных в распределенных транзакциях, охватывающих несколько микросервисов.

## Цели принятия решения

- Обеспечить согласованность данных в распределенных транзакциях.
- Минимизировать блокировки и обеспечить высокую производительность системы.

## Рассмотренные варианты

### Вариант 1: Двух-фазный коммит (2PC)

* **Описание:** Координатор управляет транзакцией, запрашивая у всех участников готовность к коммиту, а затем 
подтверждает или отменяет транзакцию.

* **Плюсы (+):**
    * Сильная согласованность.
* **Минусы (-):**
    * Блокирующий протокол, снижает производительность и доступность.
    * Координатор становится единой точкой отказа.
    * Плохо работает с длительными операциями.

### Вариант 2: Saga Pattern (Оркестрация)

* **Описание:** Оркестратор управляет выполнением шагов саги и вызывает компенсации в случае сбоя.
* **Плюсы (+):**
    * Отсутствие длительных блокировок ресурсов.
    * Четкое разделение ответственности.
* **Минусы (-):**
    * Повышенная сложность реализации.
    * Необходимость проектирования компенсирующих транзакций.

### Вариант 3: Saga Pattern (Хореография)

* **Описание:** Каждый сервис самостоятельно прослушивает события и выполняет свои действия, а в случае ошибки публикует событие для запуска компенсации.
* **Плюсы (+):**
  * Децентрализованное управление.
  * Отсутствие единой точки отказа.
  * Слабая связность сервисов.
* **Минусы (-):**
  * Сложность отслеживания потока выполнения и отладки.
  * Риск создания циклических зависимостей между событиями.

## Выбранное решение

Был выбран **Вариант 3: Saga Pattern (Хореография)**, так как он лучше соответствует принципам децентрализованной микросервисной архитектуры
и естественным образом интегрируется с асинхронной коммуникацией через Kafka.

## Последствия

* **Положительные:**
    * Обеспечение итоговой согласованности в распределенных транзакциях.
    * Повышение отказоустойчивости за счет децентрализации.
    * Слабая связность сервисов.
    * Естественная интеграция с EDA.
* **Отрицательные / Риски:**
    * Сложность отслеживания потока выполнения и отладки.
    * Необходимость тщательного проектирования событийной модели.
    * Риск создания циклических зависимостей между событиями.
* **Что нужно сделать:**
    * [] Добавление ```correlation_id``` во все события, участвующие в саге.
    * [] Обеспечение корректных действий при повторах (идемпотентность).
    * [] Обработка Dead Letter Queue.

## Дополнительные материалы

* [microservices.io/saga](https://microservices.io/patterns/data/saga.html)